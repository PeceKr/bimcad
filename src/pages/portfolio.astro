---
import BaseLayout from "../layouts/Layout.astro";
import ResidentialHouseImg from "../assets/Residential House.png";
import ChildcareImg from "../assets/Childcare.png";
import PublicServiceImg from "../assets/desktop/Desktop_WEB_VERZIJA/Portfolio/BEZ TEKST I BEZ CRNO POD NEGO/Public Service.png";
import ScanToBIMImg from "../assets/Scan To BIM.png";
import ScanToCADImg from "../assets/Scan To CAD.png";
import RevitFamiliesImg from "../assets/Revit Families.png";

// Import all portfolio images
const residentialImages = import.meta.glob('../assets/desktop/PORTFOLIO/Residential House/*.{png,jpg,jpeg}', { eager: true, query: '?url', import: 'default' });
const childcareImages = import.meta.glob('../assets/desktop/PORTFOLIO/Childcare/*.{png,jpg,jpeg}', { eager: true, query: '?url', import: 'default' });
const publicServiceImages = import.meta.glob('../assets/desktop/PORTFOLIO/Public Service/*.{png,jpg,jpeg}', { eager: true, query: '?url', import: 'default' });
const scanToBIMImages = import.meta.glob('../assets/desktop/PORTFOLIO/Scan To BIM/*.{png,jpg,jpeg}', { eager: true, query: '?url', import: 'default' });
const scanToCADImages = import.meta.glob('../assets/desktop/PORTFOLIO/Scan to CAD/*.{png,jpg,jpeg}', { eager: true, query: '?url', import: 'default' });
const revitFamiliesImages = import.meta.glob('../assets/desktop/PORTFOLIO/Revit Families/*.{png,jpg,jpeg}', { eager: true, query: '?url', import: 'default' });

const portfolioItems = [
  {
    id: 1,
    title: "Residential House",
    image: ResidentialHouseImg,
    category: "Architecture",
    folderImages: Object.values(residentialImages),
  },
  {
    id: 2,
    title: "Childcare",
    image: ChildcareImg,
    category: "Architecture",
    folderImages: Object.values(childcareImages),
  },
  {
    id: 3,
    title: "Public Service",
    image: PublicServiceImg,
    category: "Architecture",
    folderImages: Object.values(publicServiceImages),
  },
  {
    id: 4,
    title: "Scan To BIM",
    image: ScanToBIMImg,
    category: "BIM Services",
    folderImages: Object.values(scanToBIMImages),
  },
  {
    id: 5,
    title: "Scan To CAD",
    image: ScanToCADImg,
    category: "CAD Services",
    folderImages: Object.values(scanToCADImages),
  },
  {
    id: 6,
    title: "Revit Families",
    image: RevitFamiliesImg,
    category: "BIM Services",
    folderImages: Object.values(revitFamiliesImages),
  },
];
---

<BaseLayout title="Portfolio â€” BIMCAD Studio">
  <section class="relative w-full h-full bg-black overflow-hidden">
    <div class="relative z-10 h-full flex flex-col px-6 py-6 lg:px-12 lg:py-8">
      <div class="max-w-7xl mx-auto w-full flex flex-col h-full">
        <h1 class="mb-4 lg:mb-6 text-3xl lg:text-5xl font-bold text-white text-center flex-shrink-0">
          Our <span class="font-bold">Portfolio</span>
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 flex-1 auto-rows-fr overflow-hidden">
          {
            portfolioItems.map((item) => (
              <div
                class="group relative overflow-hidden rounded-lg cursor-pointer transition-transform hover:scale-105 h-full"
                data-portfolio-id={item.id}
              >
                <img
                  src={item.image.src}
                  alt={item.title}
                  class="w-full h-full object-cover"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent">
                  <div class="absolute bottom-0 left-0 right-0 p-4 lg:p-6">
                    <h3 class="text-xl lg:text-2xl font-bold text-white">{item.title}</h3>
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>

  <!-- Fullscreen Scrollable Viewer -->
  <div
    id="fullscreen-viewer"
    class="fixed inset-0 z-50 hidden bg-black overflow-y-auto overflow-x-hidden snap-y snap-mandatory"
  >
    <!-- Close button -->
    <button
      id="close-viewer"
      class="fixed top-6 right-6 text-white hover:text-gray-300 transition z-50 bg-black/50 rounded-full p-3 backdrop-blur-sm"
      aria-label="Close viewer"
    >
      <svg
        class="w-8 h-8"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <!-- Images container -->
    <div id="images-container" class="w-full h-full">
      <!-- Images will be dynamically inserted here -->
    </div>
  </div>
</BaseLayout>

<script define:vars={{ portfolioItems }}>
  const portfolioData = portfolioItems;

  document.addEventListener("DOMContentLoaded", () => {
    const viewer = document.getElementById("fullscreen-viewer");
    const imagesContainer = document.getElementById("images-container");
    const closeBtn = document.getElementById("close-viewer");
    const portfolioCards = document.querySelectorAll("[data-portfolio-id]");

    if (!viewer || !imagesContainer || !closeBtn) return;

    function createImageSlide(imageSrc, title, index, totalImages) {
      const slide = document.createElement("div");
      slide.className = "relative w-full h-screen snap-start snap-always flex items-center justify-center";
      slide.style.marginBottom = index < totalImages - 1 ? "2rem" : "0";

      slide.innerHTML = `
        <img
          src="${imageSrc}"
          alt="${title}"
          class="w-full h-full object-contain"
        />
      `;

      return slide;
    }

    function openViewer(portfolioIndex) {
      if (!imagesContainer || !viewer) return;

      imagesContainer.innerHTML = "";

      const selectedItem = portfolioData[portfolioIndex];
      const images = selectedItem.folderImages || [];

      if (images.length === 0) return;

      images.forEach((imageSrc, index) => {
        const slide = createImageSlide(imageSrc, selectedItem.title, index, images.length);
        imagesContainer.appendChild(slide);
      });

      viewer.classList.remove("hidden");
      document.body.style.overflow = "hidden";

      // Scroll to the first image
      const firstSlide = imagesContainer.children[0];
      if (firstSlide) {
        firstSlide.scrollIntoView({ behavior: "instant", block: "start" });
      }
    }

    function closeViewer() {
      if (!viewer || !imagesContainer) return;

      viewer.classList.add("hidden");
      document.body.style.overflow = "";
      imagesContainer.innerHTML = "";
    }

    portfolioCards.forEach((card) => {
      card.addEventListener("click", () => {
        const id = parseInt(card.getAttribute("data-portfolio-id") || "0", 10);
        const index = portfolioData.findIndex((item) => item.id === id);
        if (index !== -1) {
          openViewer(index);
        }
      });
    });

    closeBtn.addEventListener("click", closeViewer);

    document.addEventListener("keydown", (e) => {
      if (viewer && !viewer.classList.contains("hidden") && e.key === "Escape") {
        closeViewer();
      }
    });
  });
</script>
